// <copyright file="Class.cs" company="Gamma Four, Inc.">
//    Copyright © 2025 - Gamma Four, Inc.  All Rights Reserved.
// </copyright>
// <author>Donald Roy Airey</author>
namespace GammaFour.DataModelGenerator.Model.TableClass
{
    using System;
    using System.Collections.Generic;
    using System.Globalization;
    using System.Linq;
    using GammaFour.DataModelGenerator.Common;
    using Microsoft.CodeAnalysis;
    using Microsoft.CodeAnalysis.CSharp;
    using Microsoft.CodeAnalysis.CSharp.Syntax;

    /// <summary>
    /// Creates a row.
    /// </summary>
    public class Class : SyntaxElement
    {
        /// <summary>
        /// The unique constraint schema.
        /// </summary>
        private readonly TableElement tableElement;

        /// <summary>
        /// Initializes a new instance of the <see cref="Class"/> class.
        /// </summary>
        /// <param name="tableElement">A description of a unique constraint.</param>
        public Class(TableElement tableElement)
        {
            // Initialize the object.
            this.tableElement = tableElement;
            this.Name = tableElement.Name.ToPlural();

            //    /// <summary>
            //    /// A table of <see cref="Thing"/> rows.
            //    /// </summary>
            //    public class Things(DataModel dataModel) : IEnlistmentNotification, IEnumerable<Thing>
            //    {
            //        <Members>
            //    }
            this.Syntax = SyntaxFactory.ClassDeclaration(this.Name)
            .WithModifiers(
                SyntaxFactory.TokenList(
                    SyntaxFactory.Token(SyntaxKind.PublicKeyword)))
            .WithParameterList(
                SyntaxFactory.ParameterList(
                    SyntaxFactory.SeparatedList<ParameterSyntax>(
                        new SyntaxNodeOrToken[]
                        {
                            SyntaxFactory.Parameter(
                                SyntaxFactory.Identifier(this.tableElement.Document.Name.ToVariableName()))
                            .WithType(
                                SyntaxFactory.IdentifierName(this.tableElement.Document.Name)),
                        })))
            .WithBaseList(
                SyntaxFactory.BaseList(
                    SyntaxFactory.SeparatedList<BaseTypeSyntax>(
                        new SyntaxNodeOrToken[]
                        {
                            SyntaxFactory.SimpleBaseType(
                                SyntaxFactory.IdentifierName("IEnlistmentNotification")),
                            SyntaxFactory.Token(SyntaxKind.CommaToken),
                            SyntaxFactory.SimpleBaseType(
                                SyntaxFactory.GenericName(
                                    SyntaxFactory.Identifier("IEnumerable"))
                                .WithTypeArgumentList(
                                    SyntaxFactory.TypeArgumentList(
                                        SyntaxFactory.SingletonSeparatedList<TypeSyntax>(
                                            SyntaxFactory.IdentifierName(this.tableElement.Name))))),
                        })))
            .WithMembers(this.Members)
            .WithLeadingTrivia(this.LeadingTrivia);
        }

        /// <summary>
        /// Gets the documentation comment.
        /// </summary>
        private IEnumerable<SyntaxTrivia> LeadingTrivia
        {
            get
            {
                // The document comment trivia is collected in this list.
                List<SyntaxTrivia> comments = new List<SyntaxTrivia>
                {
                    //    /// <summary>
                    //    /// A table of <see cref="Thing"/> rows.
                    //    /// </summary>
                    SyntaxFactory.Trivia(
                        SyntaxFactory.DocumentationCommentTrivia(
                            SyntaxKind.SingleLineDocumentationCommentTrivia,
                            SyntaxFactory.SingletonList<XmlNodeSyntax>(
                                SyntaxFactory.XmlText()
                                .WithTextTokens(
                                    SyntaxFactory.TokenList(
                                        new[]
                                        {
                                            SyntaxFactory.XmlTextLiteral(
                                                SyntaxFactory.TriviaList(SyntaxFactory.DocumentationCommentExterior(Strings.CommentExterior)),
                                                " <summary>",
                                                string.Empty,
                                                SyntaxFactory.TriviaList()),
                                            SyntaxFactory.XmlTextNewLine(
                                                SyntaxFactory.TriviaList(),
                                                Environment.NewLine,
                                                string.Empty,
                                                SyntaxFactory.TriviaList()),
                                            SyntaxFactory.XmlTextLiteral(
                                                SyntaxFactory.TriviaList(SyntaxFactory.DocumentationCommentExterior(Strings.CommentExterior)),
                                                string.Format(
                                                    CultureInfo.InvariantCulture,
                                                    $" A table of <see cref=\"{this.tableElement.Name}\"/> rows.",
                                                    this.tableElement.Name),
                                                string.Empty,
                                                SyntaxFactory.TriviaList()),
                                            SyntaxFactory.XmlTextNewLine(
                                                SyntaxFactory.TriviaList(),
                                                Environment.NewLine,
                                                string.Empty,
                                                SyntaxFactory.TriviaList()),
                                            SyntaxFactory.XmlTextLiteral(
                                                SyntaxFactory.TriviaList(SyntaxFactory.DocumentationCommentExterior(Strings.CommentExterior)),
                                                " </summary>",
                                                string.Empty,
                                                SyntaxFactory.TriviaList()),
                                            SyntaxFactory.XmlTextNewLine(
                                                SyntaxFactory.TriviaList(),
                                                Environment.NewLine,
                                                string.Empty,
                                                SyntaxFactory.TriviaList()),
                                        }))))),

                    //    /// <param name="dataModel">The data model.</param>
                    SyntaxFactory.Trivia(
                        SyntaxFactory.DocumentationCommentTrivia(
                            SyntaxKind.SingleLineDocumentationCommentTrivia,
                            SyntaxFactory.SingletonList<XmlNodeSyntax>(
                                SyntaxFactory.XmlText()
                                .WithTextTokens(
                                    SyntaxFactory.TokenList(
                                        new[]
                                        {
                                            SyntaxFactory.XmlTextLiteral(
                                                SyntaxFactory.TriviaList(SyntaxFactory.DocumentationCommentExterior(Strings.CommentExterior)),
                                                $" <param name=\"{this.tableElement.Document.Name.ToCamelCase()}\">The data model.</param>",
                                                string.Empty,
                                                SyntaxFactory.TriviaList()),
                                            SyntaxFactory.XmlTextNewLine(
                                                SyntaxFactory.TriviaList(),
                                                Environment.NewLine,
                                                string.Empty,
                                                SyntaxFactory.TriviaList()),
                                        }))))),
                };

                // This is the complete document comment.
                return SyntaxFactory.TriviaList(comments);
            }
        }

        /// <summary>
        /// Gets the members syntax.
        /// </summary>
        private SyntaxList<MemberDeclarationSyntax> Members
        {
            get
            {
                // Create the members.
                SyntaxList<MemberDeclarationSyntax> members = default(SyntaxList<MemberDeclarationSyntax>);
                members = this.CreatePrivateReadonlyFields(members);
                members = this.CreatePrivateFields(members);
                members = this.CreatePublicEvents(members);
                members = this.CreatePublicProperties(members);
                members = this.CreatePublicMethods(members);
                members = Class.CreatePrivateMethods(members);
                return members;
            }
        }

        /// <summary>
        /// Create the public instance methods.
        /// </summary>
        /// <param name="members">The structure members.</param>
        /// <returns>The structure members with the methods added.</returns>
        private static SyntaxList<MemberDeclarationSyntax> CreatePrivateMethods(SyntaxList<MemberDeclarationSyntax> members)
        {
            // This will create the public instance properties.
            List<SyntaxElement> methods = new List<SyntaxElement>();

            // Alphabetize and add the methods as members of the class.
            foreach (var syntaxElement in methods.OrderBy(m => m.Name))
            {
                members = members.Add(syntaxElement.Syntax);
            }

            // Return the new collection of members.
            return members;
        }

        /// <summary>
        /// Create the private instance fields.
        /// </summary>
        /// <param name="members">The structure members.</param>
        /// <returns>The syntax for creating the internal instance properties.</returns>
        private SyntaxList<MemberDeclarationSyntax> CreatePrivateReadonlyFields(SyntaxList<MemberDeclarationSyntax> members)
        {
            // This will create the private instance fields.
            List<SyntaxElement> fields = new List<SyntaxElement>
            {
                new AsyncReaderWriterLockField(),
                new DataModelField(this.tableElement.Document),
                new DictionaryField(this.tableElement),
                new EnlistmentStatesField(),
            };

            // Alphabetize and add the fields as members of the class.
            foreach (var syntaxElement in fields.OrderBy(m => m.Name))
            {
                members = members.Add(syntaxElement.Syntax);
            }

            // Return the new collection of members.
            return members;
        }

        /// <summary>
        /// Create the private instance fields.
        /// </summary>
        /// <param name="members">The structure members.</param>
        /// <returns>The structure members with the fields added.</returns>
        private SyntaxList<MemberDeclarationSyntax> CreatePrivateFields(SyntaxList<MemberDeclarationSyntax> members)
        {
            // This will create the private instance fields.
            List<SyntaxElement> fields = new List<SyntaxElement>
            {
            };

            // Alphabetize and add the fields as members of the class.
            foreach (var syntaxElement in fields.OrderBy(f => f.Name))
            {
                members = members.Add(syntaxElement.Syntax);
            }

            // Return the new collection of members.
            return members;
        }

        /// <summary>
        /// Create the public instance properties.
        /// </summary>
        /// <param name="members">The structure members.</param>
        /// <returns>The structure members with the properties added.</returns>
        private SyntaxList<MemberDeclarationSyntax> CreatePublicProperties(SyntaxList<MemberDeclarationSyntax> members)
        {
            // This will create the public instance properties.
            List<SyntaxElement> properties = new List<SyntaxElement>
            {
                new EnlistmentStateProperty(),
            };

            // Add a history property for the master. The slave doesn't need history.
            if (this.tableElement.Document.IsMaster)
            {
                properties.Add(new HistoryProperty(this.tableElement));
            }

            // Add a property for each of the non-primary unique indices.
            foreach (UniqueIndexElement uniqueKeyElement in this.tableElement.UniqueIndexes.Where(uq => !uq.IsPrimaryIndex))
            {
                properties.Add(new UniqueIndexProperty(uniqueKeyElement));
            }

            // Alphabetize and add the properties as members of the class.
            foreach (var syntaxElement in properties.OrderBy(m => m.Name))
            {
                members = members.Add(syntaxElement.Syntax);
            }

            // Return the new collection of members.
            return members;
        }

        /// <summary>
        /// Create the public events.
        /// </summary>
        /// <param name="members">The structure members.</param>
        /// <returns>The structure members with the methods added.</returns>
        private SyntaxList<MemberDeclarationSyntax> CreatePublicEvents(SyntaxList<MemberDeclarationSyntax> members)
        {
            // This will create the public instance properties.
            List<SyntaxElement> events = new List<SyntaxElement>
            {
                new RowChangedEvent(this.tableElement),
            };

            // Alphabetize and add the events as members of the class.
            foreach (var syntaxElement in events.OrderBy(m => m.Name))
            {
                members = members.Add(syntaxElement.Syntax);
            }

            // Return the new collection of members.
            return members;
        }

        /// <summary>
        /// Create the public instance methods.
        /// </summary>
        /// <param name="members">The structure members.</param>
        /// <returns>The structure members with the methods added.</returns>
        private SyntaxList<MemberDeclarationSyntax> CreatePublicMethods(SyntaxList<MemberDeclarationSyntax> members)
        {
            // This will create the public instance properties.
            List<SyntaxElement> methods = new List<SyntaxElement>
            {
                new AddOneMethod(this.tableElement),
                new AddManyMethod(this.tableElement),
                new CommitMethod(),
                new EnterReadLockAsyncMethod(),
                new EnterWriteLockAsyncMethod(),
                new FindMethod(this.tableElement),
                new GetEnumeratorMethod(this.tableElement),
                new GenericGetEnumeratorMethod(this.tableElement),
                new InDoubtMethod(),
                new LoadMethod(this.tableElement),
                new OnRowChangedMethod(this.tableElement),
                new PatchManyMethod(this.tableElement),
                new PrepareMethod(),
                new PutOneMethod(this.tableElement),
                new RemoveManyMethod(this.tableElement),
                new RemoveOneMethod(this.tableElement),
                new RollbackMethod(),
                new TryEnterReadLockMethod(),
                new UpdateManyMethod(this.tableElement),
                new UpdateOneMethod(this.tableElement),
            };

            // Alphabetize and add the methods as members of the class.
            foreach (var syntaxElement in methods.OrderBy(m => m.Name))
            {
                members = members.Add(syntaxElement.Syntax);
            }

            // Return the new collection of members.
            return members;
        }
    }
}